<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>The Ejabberd Socket Infrastructure | Chi</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="The Ejabberd Socket Infrastructure" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Welcome to my first blog about ejabberd source code hacking. In these series of blogs, I want to take notes about how the ejabberd works, and how to hack it to get customized features." />
<meta property="og:description" content="Welcome to my first blog about ejabberd source code hacking. In these series of blogs, I want to take notes about how the ejabberd works, and how to hack it to get customized features." />
<link rel="canonical" href="https://blog.codescv.com/erlang/ejabberd/ejabberd-notes-the-listener-infrastructure.html" />
<meta property="og:url" content="https://blog.codescv.com/erlang/ejabberd/ejabberd-notes-the-listener-infrastructure.html" />
<meta property="og:site_name" content="Chi" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2012-05-23T13:49:00-05:00" />
<script type="application/ld+json">
{"headline":"The Ejabberd Socket Infrastructure","dateModified":"2012-05-23T13:49:00-05:00","datePublished":"2012-05-23T13:49:00-05:00","description":"Welcome to my first blog about ejabberd source code hacking. In these series of blogs, I want to take notes about how the ejabberd works, and how to hack it to get customized features.","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.codescv.com/erlang/ejabberd/ejabberd-notes-the-listener-infrastructure.html"},"@type":"BlogPosting","url":"https://blog.codescv.com/erlang/ejabberd/ejabberd-notes-the-listener-infrastructure.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://blog.codescv.com/feed.xml" title="Chi" /><!-- the google_analytics_id gets auto inserted from the config file -->



<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-132452726-1','auto');ga('require','displayfeatures');ga('send','pageview');</script>

<!-- the ga4 mesurement tag -->



<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-RNNG0EY45E"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-RNNG0EY45E');
</script>

<link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>The Ejabberd Socket Infrastructure | Chi</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="The Ejabberd Socket Infrastructure" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Welcome to my first blog about ejabberd source code hacking. In these series of blogs, I want to take notes about how the ejabberd works, and how to hack it to get customized features." />
<meta property="og:description" content="Welcome to my first blog about ejabberd source code hacking. In these series of blogs, I want to take notes about how the ejabberd works, and how to hack it to get customized features." />
<link rel="canonical" href="https://blog.codescv.com/erlang/ejabberd/ejabberd-notes-the-listener-infrastructure.html" />
<meta property="og:url" content="https://blog.codescv.com/erlang/ejabberd/ejabberd-notes-the-listener-infrastructure.html" />
<meta property="og:site_name" content="Chi" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2012-05-23T13:49:00-05:00" />
<script type="application/ld+json">
{"headline":"The Ejabberd Socket Infrastructure","dateModified":"2012-05-23T13:49:00-05:00","datePublished":"2012-05-23T13:49:00-05:00","description":"Welcome to my first blog about ejabberd source code hacking. In these series of blogs, I want to take notes about how the ejabberd works, and how to hack it to get customized features.","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.codescv.com/erlang/ejabberd/ejabberd-notes-the-listener-infrastructure.html"},"@type":"BlogPosting","url":"https://blog.codescv.com/erlang/ejabberd/ejabberd-notes-the-listener-infrastructure.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

<link href="https://unpkg.com/@primer/css/dist/primer.css" rel="stylesheet" />
<link rel="stylesheet" href="//use.fontawesome.com/releases/v5.0.7/css/all.css"><link type="application/atom+xml" rel="alternate" href="https://blog.codescv.com/feed.xml" title="Chi" /><!-- the google_analytics_id gets auto inserted from the config file -->



<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-132452726-1','auto');ga('require','displayfeatures');ga('send','pageview');</script>


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"> </script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Chi</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About Me</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">The Ejabberd Socket Infrastructure</h1><p class="post-meta post-meta-title"><time class="dt-published" datetime="2012-05-23T13:49:00-05:00" itemprop="datePublished">
        May 23, 2012
      </time>
       â€¢ <span class="read-time" title="Estimated read time">
    
    
      6 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#erlang">erlang</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#ejabberd">ejabberd</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>Welcome to my first blog about ejabberd source code hacking. In these series of blogs, I want to take notes about how the <a href="http://www.ejabberd.im/">ejabberd</a> works, and how to hack it to get customized features.</p>

<p>The source code version in discussion is ejabberd 2.1.10 release, which is the latest stable version at this time.</p>

<h2 id="intro">Intro</h2>
<p>The first step to source hacking is code reading. Ejabberd is a big project (with 80k+lines of erlang code), so itâ€™s impossible for us to understand it all at once. Like reading a book, we need to get the key idea first.</p>

<p>What is the key idea of this XMPP(Jabber) server, then? Letâ€™s review some of the key usages of a typical XMPP session:</p>

<ol>
  <li>Alice started an XMPP client on her computer, which establishes a TCP connection to xmpp.example.org:5222.</li>
  <li>The server authenticates the client by exchanging XML stanzas.</li>
  <li>Alice uses the XMPP client to exchange messages/presences/iqs with the server, completing tasks such as instant messaging and presence notifying.</li>
</ol>

<p>The essential task of the server, then, is to listen on a specific port, wait for clients or other servers to connect to it, and then exchange information using specific data formats(in the XMPPâ€™s situation, XML stanzas).</p>

<p>That said, letâ€™s examine the listener/socket code of ejabberd first, throwing aside other features along the way.</p>

<p><em>Notice</em>: for the sake of clearity, I intentionally omitted a lot of code which are either unrelated to the topic discussed or only used for error handling.</p>

<h2 id="binding-listener-ports">Binding listener ports</h2>
<p>In ejabberd, the whole server is packaged into a single OTP application.</p>

<p>The modules related to ejabberdâ€™s socket infrastructure are: ejabberd_listener, ejabberd_socket and ejabberd_receiver.</p>

<p>The ejabberd_listener listens on every port specified in the ejabberd configuration file, spawns a process for each port and then accepts the sockets. When it finishes, it starts ejabberd_socket which in turn starts two processes: ejabberd_receiver and logic module according to the config (ejabberd_c2s for 5222, for example). The ejabberd_receiver is responsible for receiving any incoming packets and then forwarding them to the logic module. The logic module parses and handles the packets, and sends responses and requests using the ejabberd_socket utils.</p>

<p>Letâ€™s start with the application module:</p>

<figure class="highlight"><pre><code class="language-erlang" data-lang="erlang"><span class="c">%% file: ejabberd_app.erl 
</span><span class="nf">start</span><span class="p">(</span><span class="n">normal</span><span class="p">,</span> <span class="p">_</span><span class="nv">Args</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nv">Sup</span> <span class="o">=</span> <span class="nn">ejabberd_sup</span><span class="p">:</span><span class="nf">start_link</span><span class="p">(),</span>
    <span class="nn">ejabberd_listener</span><span class="p">:</span><span class="nf">start_listeners</span><span class="p">().</span></code></pre></figure>

<p>In ejabberd_sup:start_link/0, ejabberd_listener:start_link/0 is invoked:</p>

<figure class="highlight"><pre><code class="language-erlang" data-lang="erlang"><span class="c">%% ejabberd_sup.erl 
</span><span class="nf">init</span><span class="p">([])</span> <span class="o">-&gt;</span>
    <span class="nv">Listener</span> <span class="o">=</span>
    <span class="p">{</span><span class="n">ejabberd_listener</span><span class="p">,</span>
     <span class="p">{</span><span class="n">ejabberd_listener</span><span class="p">,</span> <span class="n">start_link</span><span class="p">,</span> <span class="p">[]},</span>
     <span class="n">permanent</span><span class="p">,</span>
     <span class="n">infinity</span><span class="p">,</span>
     <span class="n">supervisor</span><span class="p">,</span>
     <span class="p">[</span><span class="n">ejabberd_listener</span><span class="p">]}.</span></code></pre></figure>

<p>Inside ejabberd_listener:init/0, the tcp and udp ports are bound according to the config file:</p>

<figure class="highlight"><pre><code class="language-erlang" data-lang="erlang"><span class="c">%% file: ejabberd_listener.erl 
</span><span class="nf">init</span><span class="p">(_)</span> <span class="o">-&gt;</span>
    <span class="nn">ets</span><span class="p">:</span><span class="nf">new</span><span class="p">(</span><span class="n">listen_sockets</span><span class="p">,</span> <span class="p">[</span><span class="n">named_table</span><span class="p">,</span> <span class="n">public</span><span class="p">]),</span>
    <span class="nf">bind_tcp_ports</span><span class="p">(),</span>
    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="p">{</span> <span class="p">{</span><span class="n">one_for_one</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="p">[]}}.</span>

<span class="nf">bind_tcp_ports</span><span class="p">()</span> <span class="o">-&gt;</span>
    <span class="k">case</span> <span class="nn">ejabberd_config</span><span class="p">:</span><span class="nf">get_local_option</span><span class="p">(</span><span class="n">listen</span><span class="p">)</span> <span class="k">of</span>
        <span class="nv">Ls</span> <span class="o">-&gt;</span>
            <span class="nn">lists</span><span class="p">:</span><span class="nf">foreach</span><span class="p">(</span>
              <span class="k">fun</span><span class="p">({</span><span class="nv">Port</span><span class="p">,</span> <span class="nv">Module</span><span class="p">,</span> <span class="nv">Opts</span><span class="p">})</span> <span class="o">-&gt;</span>
                  <span class="nf">bind_tcp_port</span><span class="p">(</span><span class="nv">Port</span><span class="p">,</span> <span class="nv">Module</span><span class="p">,</span> <span class="nv">Opts</span><span class="p">)</span>
              <span class="k">end</span><span class="p">,</span>
              <span class="nv">Ls</span><span class="p">)</span>
    <span class="k">end</span><span class="p">.</span>

<span class="nf">bind_tcp_port</span><span class="p">(</span><span class="nv">PortIP</span><span class="p">,</span> <span class="nv">Module</span><span class="p">,</span> <span class="nv">RawOpts</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="c">%% portip has the following format: {5222, {0,0,0,0},tcp}
</span>    <span class="p">{</span><span class="nv">Port</span><span class="p">,</span> <span class="nv">IPT</span><span class="p">,</span> <span class="nv">IPS</span><span class="p">,</span> <span class="nv">IPV</span><span class="p">,</span> <span class="nv">Proto</span><span class="p">,</span> <span class="nv">OptsClean</span><span class="p">}</span> <span class="o">=</span> <span class="nf">parse_listener_portip</span><span class="p">(</span><span class="nv">PortIP</span><span class="p">,</span> <span class="nv">RawOpts</span><span class="p">),</span>
    <span class="p">_</span><span class="nv">Opts</span><span class="p">,</span> <span class="nv">SockOpts</span><span class="p">}</span> <span class="o">=</span> <span class="nf">prepare_opts</span><span class="p">(</span><span class="nv">IPT</span><span class="p">,</span> <span class="nv">IPV</span><span class="p">,</span> <span class="nv">OptsClean</span><span class="p">),</span>
    <span class="c">%% save parsed listener options into ets table
</span>    <span class="nf">listen_tcp</span><span class="p">(</span><span class="nv">PortIP</span><span class="p">,</span> <span class="nv">Module</span><span class="p">,</span> <span class="nv">SockOpts</span><span class="p">,</span> <span class="nv">Port</span><span class="p">,</span> <span class="nv">IPS</span><span class="p">).</span>

<span class="nf">listen_tcp</span><span class="p">(</span><span class="nv">PortIP</span><span class="p">,</span> <span class="nv">Module</span><span class="p">,</span> <span class="nv">SockOpts</span><span class="p">,</span> <span class="nv">Port</span><span class="p">,</span> <span class="nv">IPS</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nn">gen_tcp</span><span class="p">:</span><span class="nf">listen</span><span class="p">(</span><span class="nv">Port</span><span class="p">,</span> <span class="p">[</span><span class="n">binary</span><span class="p">,</span>
                <span class="p">{</span><span class="n">packet</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
                <span class="p">{</span><span class="n">active</span><span class="p">,</span> <span class="n">false</span><span class="p">},</span>
                <span class="p">{</span><span class="n">reuseaddr</span><span class="p">,</span> <span class="n">true</span><span class="p">},</span>
                <span class="p">{</span><span class="n">nodelay</span><span class="p">,</span> <span class="n">true</span><span class="p">},</span>
                <span class="p">{</span><span class="n">send_timeout</span><span class="p">,</span> <span class="o">?</span><span class="nv">TCP_SEND_TIMEOUT</span><span class="p">},</span>
                <span class="p">{</span><span class="n">keepalive</span><span class="p">,</span> <span class="n">true</span><span class="p">}</span> <span class="p">|</span>
                <span class="nv">SockOpts</span><span class="p">]).</span></code></pre></figure>

<p>After ejabberd_listener:init/0 is finished, all the ports specified in the config file are opened(in the listening state), but not accepting any incoming connections yet.</p>

<h2 id="accept-incoming-connections">Accept incoming connections</h2>
<p>Next, the sockets start accepting incoming connections in ejabberd_listener:start_listeners/0:</p>

<figure class="highlight"><pre><code class="language-erlang" data-lang="erlang"><span class="c">%% file: ejabberd_listener.erl 
</span><span class="nf">start_listeners</span><span class="p">()</span> <span class="o">-&gt;</span>
    <span class="c">%% load listeners config from ets table
</span>    <span class="nv">Ls2</span> <span class="o">=</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">map</span><span class="p">(</span>
        <span class="k">fun</span><span class="p">({</span><span class="nv">Port</span><span class="p">,</span> <span class="nv">Module</span><span class="p">,</span> <span class="nv">Opts</span><span class="p">})</span> <span class="o">-&gt;</span>
            <span class="nf">start_listener</span><span class="p">(</span><span class="nv">Port</span><span class="p">,</span> <span class="nv">Module</span><span class="p">,</span> <span class="nv">Opts</span><span class="p">)</span>
        <span class="k">end</span>
    <span class="k">end</span><span class="p">,</span> <span class="nv">Listeners</span><span class="p">).</span>
    
<span class="nf">start_listener</span><span class="p">(</span><span class="nv">Port</span><span class="p">,</span> <span class="nv">Module</span><span class="p">,</span> <span class="nv">Opts</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nv">ChildSpec</span> <span class="o">=</span> <span class="p">{</span><span class="nv">Port</span><span class="p">,</span>
         <span class="p">{</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="p">[</span><span class="nv">Port</span><span class="p">,</span> <span class="nv">Module</span><span class="p">,</span> <span class="nv">Opts</span><span class="p">]},</span>
         <span class="n">transient</span><span class="p">,</span>
         <span class="n">brutal_kill</span><span class="p">,</span>
         <span class="n">worker</span><span class="p">,</span>
         <span class="p">[</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">]},</span>
    <span class="nn">supervisor</span><span class="p">:</span><span class="nf">start_child</span><span class="p">(</span><span class="n">ejabberd_listeners</span><span class="p">,</span> <span class="nv">ChildSpec</span><span class="p">).</span>
    
<span class="nf">start</span><span class="p">(</span><span class="nv">Port</span><span class="p">,</span> <span class="nv">Module</span><span class="p">,</span> <span class="nv">Opts</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nn">proc_lib</span><span class="p">:</span><span class="nf">start_link</span><span class="p">(</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="p">[</span><span class="nv">Port</span><span class="p">,</span> <span class="nv">Module</span><span class="p">,</span> <span class="nv">Opts</span><span class="p">]).</span>

<span class="nf">init</span><span class="p">(</span><span class="nv">PortIP</span><span class="p">,</span> <span class="nv">Module</span><span class="p">,</span> <span class="nv">RawOpts</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="nv">Port</span><span class="p">,</span> <span class="nv">IPT</span><span class="p">,</span> <span class="nv">IPS</span><span class="p">,</span> <span class="nv">IPV</span><span class="p">,</span> <span class="nv">Proto</span><span class="p">,</span> <span class="nv">OptsClean</span><span class="p">}</span> <span class="o">=</span> <span class="nf">parse_listener_portip</span><span class="p">(</span><span class="nv">PortIP</span><span class="p">,</span> <span class="nv">RawOpts</span><span class="p">),</span>
    <span class="p">{</span><span class="nv">Opts</span><span class="p">,</span> <span class="nv">SockOpts</span><span class="p">}</span> <span class="o">=</span> <span class="nf">prepare_opts</span><span class="p">(</span><span class="nv">IPT</span><span class="p">,</span> <span class="nv">IPV</span><span class="p">,</span> <span class="nv">OptsClean</span><span class="p">),</span>
    <span class="nf">init_tcp</span><span class="p">(</span><span class="nv">PortIP</span><span class="p">,</span> <span class="nv">Module</span><span class="p">,</span> <span class="nv">Opts</span><span class="p">,</span> <span class="nv">SockOpts</span><span class="p">,</span> <span class="nv">Port</span><span class="p">,</span> <span class="nv">IPS</span><span class="p">)</span>

<span class="nf">init_tcp</span><span class="p">(</span><span class="nv">PortIP</span><span class="p">,</span> <span class="nv">Module</span><span class="p">,</span> <span class="nv">Opts</span><span class="p">,</span> <span class="nv">SockOpts</span><span class="p">,</span> <span class="nv">Port</span><span class="p">,</span> <span class="nv">IPS</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nv">ListenSocket</span> <span class="o">=</span> <span class="nf">listen_tcp</span><span class="p">(</span><span class="nv">PortIP</span><span class="p">,</span> <span class="nv">Module</span><span class="p">,</span> <span class="nv">SockOpts</span><span class="p">,</span> <span class="nv">Port</span><span class="p">,</span> <span class="nv">IPS</span><span class="p">),</span>
    <span class="nn">proc_lib</span><span class="p">:</span><span class="nf">init_ack</span><span class="p">({</span><span class="n">ok</span><span class="p">,</span> <span class="nf">self</span><span class="p">()}),</span>
    <span class="nf">accept</span><span class="p">(</span><span class="nv">ListenSocket</span><span class="p">,</span> <span class="nv">Module</span><span class="p">,</span> <span class="nv">Opts</span><span class="p">).</span>
    
<span class="nf">accept</span><span class="p">(</span><span class="nv">ListenSocket</span><span class="p">,</span> <span class="nv">Module</span><span class="p">,</span> <span class="nv">Opts</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="k">case</span> <span class="nn">gen_tcp</span><span class="p">:</span><span class="nf">accept</span><span class="p">(</span><span class="nv">ListenSocket</span><span class="p">)</span> <span class="k">of</span>
    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">}</span> <span class="o">-&gt;</span>
        <span class="nn">ejabberd_socket</span><span class="p">:</span><span class="nf">start</span><span class="p">(</span><span class="nv">Module</span><span class="p">,</span> <span class="n">gen_tcp</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">,</span> <span class="nv">Opts</span><span class="p">),</span>
        <span class="nf">accept</span><span class="p">(</span><span class="nv">ListenSocket</span><span class="p">,</span> <span class="nv">Module</span><span class="p">,</span> <span class="nv">Opts</span><span class="p">);</span>
    <span class="p">{</span><span class="n">error</span><span class="p">,</span> <span class="nv">Reason</span><span class="p">}</span> <span class="o">-&gt;</span>
        <span class="nf">accept</span><span class="p">(</span><span class="nv">ListenSocket</span><span class="p">,</span> <span class="nv">Module</span><span class="p">,</span> <span class="nv">Opts</span><span class="p">)</span>
    <span class="k">end</span><span class="p">.</span></code></pre></figure>

<p>As we see the code above, the start_listeners/0 call spawns a new process for each listened ports, and then link it to the ejabberd_listeners supervisor, which is started in ejabberd_listener:start_link/0. This may seem odd to you at first, as it DOES for me, since normally a supervisorâ€™s callbacks and its workersâ€™ callbacks ought to be put in separate modules. Donâ€™t write code like that; it causes confusions.</p>

<p>If you are careful enough, you might notice that the sockets are listened twice(once in bind_tcp_ports/0, once in start_listeners/0). I am not sure why it is implemented that way; it works perfectly if I removed one of them.</p>

<h2 id="start-handling-requests">Start handling requests</h2>
<p>Anyway, letâ€™s continue to see what happens when a socket is accepted:</p>

<figure class="highlight"><pre><code class="language-erlang" data-lang="erlang"><span class="c">%% file: ejabberd_socket.erl 
</span><span class="nf">start</span><span class="p">(</span><span class="nv">Module</span><span class="p">,</span> <span class="nv">SockMod</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">,</span> <span class="nv">Opts</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nv">ReceiverMod</span> <span class="o">=</span> <span class="n">ejabberd_receiver</span><span class="p">,</span>  <span class="c">%% see explanation
</span>    <span class="nv">RecPid</span> <span class="o">=</span> <span class="nv">ReceiverMod</span><span class="p">:</span><span class="nf">start</span><span class="p">(</span><span class="nv">Socket</span><span class="p">,</span> <span class="nv">SockMod</span><span class="p">,</span> <span class="n">none</span><span class="p">,</span> <span class="nv">MaxStanzaSize</span><span class="p">),</span>
    <span class="nv">SocketData</span> <span class="o">=</span> <span class="nl">#socket_state</span><span class="p">{</span><span class="n">sockmod</span> <span class="o">=</span> <span class="nv">SockMod</span><span class="p">,</span>
                   <span class="n">socket</span> <span class="o">=</span> <span class="nv">Socket</span><span class="p">,</span>
                   <span class="n">receiver</span> <span class="o">=</span> <span class="nv">RecPid</span><span class="p">},</span>
    <span class="k">case</span> <span class="nv">Module</span><span class="p">:</span><span class="nf">start</span><span class="p">({</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="nv">SocketData</span><span class="p">},</span> <span class="nv">Opts</span><span class="p">)</span> <span class="k">of</span>
        <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Pid</span><span class="p">}</span> <span class="o">-&gt;</span>
            <span class="nv">SockMod</span><span class="p">:</span><span class="nf">controlling_process</span><span class="p">(</span><span class="nv">Socket</span><span class="p">,</span> <span class="nv">Receiver</span><span class="p">)</span> <span class="k">of</span>
            <span class="nv">ReceiverMod</span><span class="p">:</span><span class="nf">become_controller</span><span class="p">(</span><span class="nv">Receiver</span><span class="p">,</span> <span class="nv">Pid</span><span class="p">);</span>
        <span class="p">{</span><span class="n">error</span><span class="p">,</span> <span class="p">_</span><span class="nv">Reason</span><span class="p">}</span> <span class="o">-&gt;</span>
            <span class="nv">ReceiverMod</span><span class="p">:</span><span class="nf">close</span><span class="p">(</span><span class="nv">Receiver</span><span class="p">);</span>
    <span class="k">end</span><span class="p">;</span></code></pre></figure>

<p>When a new socket is accepted, ejabberd_socket:start/4 is invoked to handle the socket events. ejabberd (brightly) splitted this task into two subtasks: one is to handle all the data transmition(sending and receiving, encapsulating the low-level socket implementation), the other is to parse and handle the message corresponding to the data. Hence, as we see here, a receiver process (ReceiverMod) and a logic handling process (Module) are spawned. The receiver module defaults to ejabberd_receiver, which receives XML stanzas and forwards the stanzas to the logic module. The logic module, on the other hand, may be ejabberd_c2s.erl or ejabberd_s2s depending for different tasks.</p>

<p>What â€˜SockMod:controlling_process(Socket, Receiver)â€™ does is to direct all data sent to the socket to the receiver mod, which then can handle all the incoming data. After the logic module starts, â€˜ReceiverMod:become_controller(Receiver, Pid)â€™ is called to let the receiver know where to forward incoming message to.</p>

<p>In a word, ejabberd starts a receiver and a handler when a socket is accepted, the receiver handles all incoming data, does some preprocessing(such as parsing the XML) and forward the message to the handler, the handler decides how to handle the message, and (maybe) use the ejabberd_socket util to send response data. If you want to extend the ejabberd to use other protocols than XMPP: this is the place to start. Write a customized receiver module to parse the protocol, a customized handler module to handle all the requests and you are done. More on this topic later.</p>

<h2 id="to-sum-up">To sum up</h2>
<p>We have taken a quick tour through the socket infrastructure in ejabberd. We learned that the ejabberd uses three modules: ejabberd_listener, ejabberd_socket and ejabberd_receiver to handle all the socket related stuff. ejabberd_listener binds and listens on ports, ejabberd_socket starts the receiver and the handler, and provides utils for outgoing data, the receiver handles and parses all incoming data, and forwards messages to the logic module. The logics, on the other handle, are handled by logic modules accroding to the config file. There are, however, many things that we left out, including:</p>

<ol>
  <li>customization of receiver/logic modules.</li>
  <li>congestion control (shapers).</li>
  <li>how the logic modules interacts with the socket infrastructure.</li>
</ol>

<p>So get your hands on the code piece by piece, make discoveries, and have fun! :)</p>


  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="codescv/blog"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/erlang/ejabberd/ejabberd-notes-the-listener-infrastructure.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Chi&#39;s blog about ML, NLP, Programming and others.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/codescv" title="codescv"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/codescv" title="codescv"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
